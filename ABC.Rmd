---
title: "North Korea COVID-19 "
author: Jong-Hoon Kim
date: March 22, 2005
output:
  md_document:
    variant: markdown_github
editor_options: 
  chunk_output_type: console
---

```{r global_options, echo=F}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE)
```

### Package install
```{r}
# remove.packages("COVID19NorthKorea")
# When earlier installation causes an issue, deleting the package folder under, C:\Users\jonghoon.kim\AppData\Local\R\win-library\4.2, solved.
# devtools::install()
# library(COVID19NorthKorea)
# devtools::load_all() #Ctrl-Shift-L
```

### Data
```{r}
# overall covid data
covid_overall <- readRDS("data/covid_overall_20230122.rds")
# population by province - used to set the initial province-specific population size
pop <- readRDS("data/pop_by_province_20230213.rds")
# covid case by province
covid <- readRDS("data/covid_by_province_20230213.rds")

library(ggplot2)
df <- covid_overall
p<-ggplot(df, aes(date, symptomatic))+
  geom_col(fill="brown", alpha=0.5)+
  theme_bw() +
  labs(x="", y="Symptomatic case")+
  scale_x_date(date_breaks="2 weeks", date_labels="%Y-%m-%d",
               limits=c(min(df$date), max(df$date)))+
  theme(axis.text.x=element_text(angle=60, hjust=1))
p

ggsave(sprintf("plots/covid_symptomatic_overall_%s.png", tstamp()), p, width=3.4*1.2, height=2.7*1.2)

# 	당일 발생자수 소계	당일 완쾌자수 소계	당일 사망자 수 소계
# 평양	608,063 	662,337 	12 
# 평북	354,206 	388,616 	1 
# 평남	425,965 	437,789 	5 
# 황북	325,755 	340,737 	0 
# 황남	359,760 	351,613 	3 
# 자강	125,578 	156,617 	0 
# 강원	225,445 	258,248 	7 
# 함북	57,885 	76,775 	1 
# 함남	245,487 	257,001 	2 
# 양강	114,316 	129,966 	8 
# 남포	133,089 	149,035 	0 
# 나선	54,660 	64,317 	0 
# 개성	87,039 	92,073 	1 
# 조선중앙TV 소계	3,117,248 	3,365,124 	40 
# 노동신문 총계	4,772,813 	4,772,739 	74 
d = data.frame(recovered = c(662337,388616,437789,340737,351613,156617,258248,76775,257001,129966,149035,64317,92073),
area = c("평양","평북","평남","황북","황남","자강","강원","함북","함남","양강","남포","나선","개성"))
# d[order(d$area),]
pop$area = pop$Province_Korean

pop[order(pop$Province_Korean), c("Province_Korean", "Total")]
library(dplyr)
d2 = left_join(pop[,c("area","Total")], d, by="area")
d2$attack_rate = d2$recovered/d2$Total
```

draw_params function is created to check if daily_incidence and get_sum_stat function generate valid output for different values of parameters
```{r}
prior <- list(c("unif",5,150), c("unif",1,20), c("unif",-5,10), 
              c("unif",0.1,2))

PARAMETERS <- params_init(pop=sum(pop$Total))

for(i in 1:10){
  parm <- draw_params(prior)
  message(parm)
  daily_incidence(pars=parm)
  get_sum_stat(pars=parm)
}
```



```{r}
dat <- readRDS("data/covid_overall_20230122.rds")
pop <- readRDS("data/pop_by_province_20230213.rds")
fit <- readRDS("outputs/smc_sepiar_euler_20230329T1338.rds")
# Number of people who were already symptomatic before the first case was officially reported
unreported <- dat$cumul_symptomatic[1] - dat$symptomatic[1] 

# Model parameters
# These are global parameters and name has to be PARAMETERS
# PARAMETERS <- params_init(pop=sum(pop$Total))
PARAMETERS <- initialize_params(pop=sum(pop$Total))
PARAMETERS$model <- sepiar_stoch
print_params(params=PARAMETERS)
# PARAMETERS$measure_var <- "CI" # to compare symptomatic case
sum_stat_obs <- c(unreported, dat$symptomatic[1:PARAMETERS$obslength])  

testpars <- c(33, 8.9, 2,5, 0.6)
PARAMETERS$model <- sepiar_euler

di <- daily_incidence(pars=testpars)
ssmodel <- get_sum_stat(pars=testpars)
(length(sum_stat_obs)) 
(length(ssmodel))
sqrt(sum(ssmodel - sum_stat_obs))
library(EasyABC)
## ABC parameters
prior <- list(c("unif",1,100), c("unif",1,20), c("unif",-10,20), 
              c("unif",0.001,1))
nsim <- 50
alpha <- 0.8
tol <- 2
nrep <- 1                          

set.seed(42)
res <- ABC_sequential(method="Delmoral",
                      model=get_sum_stat,
                      prior=prior, 
                      nb_simul=nsim,
                      summary_stat_target=sum_stat_obs, 
                      alpha=alpha,
                      tolerance_target=tol, 
                      verbose=F, 
                      M=nrep)

apply(res$param, 2, summary)

## set time limit
res <- run_with_timelimit(2, ABC_sequential(method="Delmoral",
                      model=get_sum_stat,
                      prior=prior, 
                      nb_simul=nsim,
                      summary_stat_target=sum_stat_obs, 
                      alpha=alpha,
                      tolerance_target=tol, 
                      verbose=F, 
                      M=nrep))
res

res = run_abc_with_decreasing_tol(method="Delmoral",
                              timelimit=20*60, 
                            init_tol=15, 
                            decrement=0.2, 
                            niter=15, 
                            seed=i,
                            prior=prior, 
                            target=sum_stat_obs,
                            model=get_sum_stat,
                            nsim=30, 
                            nrep=nrep, 
                            alpha=alpha)
```

### Fit overall COVID-19 epidemic

if the day of introduction is extended to 300 days, the Delmoral method does not seem to converge. This may be that the early introduction of the infection generates a more complex scenario of potential two peaks, which makes exploring parameter space challenging

We modeled the epidemic using four parameters.
1. Time that the initial cases were imported
2. Reproduction number before intervention efforts were in place (basic reproduction number)
3. Time when the effects of intervention appeared
4. Reproduction number after the intervention program

We assume that the effect of intervention program instantaneously reaches its maximum.

Estimate parameters for the SEPIAR model with tau of 1 day
Start with 20 different random seeds (1 to 20) and combine the estimated parameters. Preliminary searches suggested that tolerance target of 5 gives reasonable fits. Starting with 5, the tolerance target was reduced by 0.2 increment. Simulation was run for 20 minutes for a given parameter values and stopped if the parameter sets did not converge.

```{r fit_overall}
dat <- readRDS("data/covid_overall_20230122.rds")
pop <- readRDS("data/pop_by_province_20230213.rds")

# Number of people who were already symptomatic before the first case was officially reported
nsymp <- dat$cumul_symptomatic[1] - dat$symptomatic[1] 

# Model parameters
# These are global parameters and name has to be PARAMETERS
PARAMETERS <- params_init(pop=sum(pop$Total))
sum_stat_obs <- c(nsymp, dat$symptomatic[1:PARAMETERS$obslength])  

testpars <- c(50, 6, 0, 0.6)
di <- daily_incidence(pars=testpars)
ssmodel <- get_sum_stat(pars=testpars)
(length(sum_stat_obs)) 
(length(ssmodel))

library(EasyABC)
## ABC parameters
prior <- list(c("unif",5,150), c("unif",1,20), c("unif",-5,10), 
              c("unif",0.1,2))
nsim <- 50
alpha <- 0.9
tol <- 5
nrep <- 10                          
timelim <- 10*60 # some runs can take long depending on the tol
for (s in 1:20) {
  cat("seed =", s, "\n")
  for(r in 1:10){
    set.seed(s)
    cat("tol =", tol, "\n")
    res <-  run_with_timelimit(timelim, ABC_sequential(method="Delmoral",
                        model=get_sum_stat,
                        prior=prior, 
                        nb_simul=nsim,
                        summary_stat_target=sum_stat_obs, 
                        alpha=alpha,
                        tolerance_target=tol, 
                        verbose=F, 
                        M=nrep))
    tstamp <- timestamp(hour=T, minute=T, second=T)
    saveRDS(res, sprintf("outputs/abc_alpha_%s_tol_%s_seed_%s_%s.rds",
                         alpha, tol, s, tstamp))
  
    if (is.null(res)) break;
    tol <- tol - 0.2
  }
}
```


### Run ABC with decreasing tolerance
```{r}
devtools::load_all()

dat <- readRDS("data/covid_overall_20230122.rds")
pop <- readRDS("data/pop_by_province_20230213.rds")

nsymp <- dat$cumul_symptomatic[1] - dat$symptomatic[1] 

# PARAMETERS <- params_init(pop=sum(pop$Total))
PARAMETERS <- params_init(pop=sum(pop$Total), erlang=F)
sum_stat_obs <- c(nsymp, dat$symptomatic[1:PARAMETERS$obslength])  

library(EasyABC)
## ABC parameters
prior <- list(c("unif",5,150), c("unif",1,20),
              c("unif",-5,10), 
              c("unif",0.1,2))
nsim <- 50
alpha <- 0.9
nrep <- 10                          

tic <- Sys.time()

nrun <- 50
for(i in 41:nrun){
  run_abc_with_decreasing_tol(method="Delmoral",
                              timelimit=20*60, 
                            init_tol=2.9, 
                            decrement=0.2, 
                            niter=15, 
                            seed=i,
                            prior=prior, 
                            target=sum_stat_obs,
                            model=get_sum_stat,
                            nsim=nsim, 
                            nrep=nrep, 
                            alpha=alpha)
}
Sys.time() - tic
```


### Run ABC with decreasing tolerance - province
```{r}
devtools::load_all()
pop <- readRDS("data/pop_by_province_20230213.rds")
datall <- readRDS("data/covid_by_province_20230213.rds")

replace_NA_with_previous <- function(x){
  for(j in 2:length(x)){   
    x[j] <- ifelse(is.na(x[j]), x[j-1], x[j]) 
  }
  return (x)
}

library(EasyABC)
prior <- list(c("unif",0,100), c("unif",1,20), 
              c("unif",-5,10), c("unif",0.1,5))

nsim <- 50
alpha <- 0.9
nrep <- 10

timelim <- 10*60 # 10 minutes
# PARAMETERS
measure_var <- "CI"
erlang <- FALSE  
obslength <- 70

for(i in 1:nrow(pop)) {
  dat <- datall[datall$province == pop$Province_Korean[i],]
  dat$day <- 0:(nrow(dat)-1)
  # is this a reasonable assumption
  case_before <- dat$`치료중 환자수`[1] +
    dat$`당일 완쾌자수`[1] - dat$`당일 발생자수`[1] 
  sum_stat_obs <- c(case_before, dat$case[1:obslength])
  sum_stat_obs <- replace_NA_with_previous(sum_stat_obs)
  
  # set the global variables ------------------
  # initial population size by region
  PARAMETERS <- params_init(I0=3, erlang=erlang,
                            region=pop$province_clean[i])
  PARAMETERS$measure_var <- measure_var
  PARAMETERS$obslength <- obslength
  # -----------------------------------------------
  tol <- 10

  nrun <- 15 # diffrent random seekds of nrun
  for(i in 1:nrun){
    run_abc_with_decreasing_tol(method="Delmoral",
                                timelimit=20*60, 
                                init_tol=0.02, 
                                decrement=0.005, 
                                niter=5, 
                                seed=i,
                                prior=prior, 
                                target=sum_stat_obs,
                                model=get_sum_stat,
                                nsim=nsim, 
                                nrep=nrep, 
                                alpha=alpha)
  }
}
```


### Parallel with run_with_decrement
```{r}

# devtools::load_all()
# devtools::install()
library(COVID19NorthKorea)
library(foreach)
library(doParallel)

dat <- readRDS("data/covid_overall_20230122.rds")
pop <- readRDS("data/pop_by_province_20230213.rds")

nsymp <- dat$cumul_symptomatic[1] - dat$symptomatic[1] 

PARAMETERS <- params_init(pop=sum(pop$Total))
sum_stat_obs <- c(nsymp, dat$symptomatic[1:PARAMETERS$obslength])  

testpars <- c(50, 6, 0, 0.6)
# di <- daily_incidence(pars=testpars)
# ssmodel <- get_sum_stat(pars=testpars)
# (length(sum_stat_obs)) 
# (length(ssmodel))

library(EasyABC)
## ABC parameters
prior <- list(c("unif",5,150), c("unif",1,20), c("unif",-5,10), 
              c("unif",0.1,2))
nsim <- 50
alpha <- 0.9
tol <- 5
nrep <- 10                          

tic <- Sys.time()

cl <- makeCluster(8)
registerDoParallel(cl)

resp <- foreach(i=1:8,
                .packages=c("EasyABC", "COVID19NorthKorea"),
                .combine = 'rbind') %dopar% {
  # set.seed(i)
  COVID19NorthKorea::run_abc_with_decreasing_tol(timelimit=1200, 
                              init_tol=6, 
                              decrement=0.2, 
                              niter=10, 
                              seed=i,
                              prior=prior, 
                              target=sum_stat_obs,
                              model = get_sum_stat,
                              nsim=nsim, 
                              nrep=nrep, 
                              alpha=alpha)
                  
}
stopImplicitCluster()

Sys.time() - tic

```

### Erlang-distributed waiting time 
```{r fit_overall_erlang}
devtools::load_all()

dat <- readRDS("data/covid_overall_20230122.rds")
pop <- readRDS("data/pop_by_province_20230213.rds")

nsymp <- dat$cumul_symptomatic[1] - dat$symptomatic[1] 

PARAMETERS <- params_init(pop=sum(pop$Total), erlang=TRUE)
sum_stat_obs <- c(nsymp, dat$symptomatic[1:PARAMETERS$obslength])  

# testpars <- c(50, 6, 0, 0.6)
# di <- daily_incidence(pars=testpars)
# ssmodel <- get_sum_stat(pars=testpars)
# (length(sum_stat_obs)) 
# (length(ssmodel))

library(EasyABC)
# prior <- list(c("unif",5,150), c("unif",1,20), c("unif",-5,10), 
#               c("unif",0.1,2))
prior <- list(c("unif",5,100), c("unif",1,20), c("unif",-5,10), 
              c("unif",0.1,1))
nsim <- 50
alpha <- 0.9
tol <- 9
nrep <- 10                          
timelim <- 20*60 # some runs can take long depending on the tol
for (s in 11:19) {
  cat("seed =", s, ", tolerance_target =", tol,"\n")
  set.seed(s)
  res <-  run_with_timelimit(timelim, 
                             ABC_sequential(method="Delmoral",
                             model=get_sum_stat,
                             prior=prior, 
                             nb_simul=nsim,
                             summary_stat_target=sum_stat_obs, 
                             alpha=alpha,
                             tolerance_target=tol, 
                             verbose=F, 
                             M=nrep))
  # if (is.null(res)) break;
  if (!is.null(res)) {
    tstamp <- timestamp(hour=T, minute=T, second=T)
    saveRDS(res, sprintf("outputs/abc_erlang_alpha_%s_tol_%s_seed_%s_%s.rds", alpha, tol, s, tstamp))
  
    tol <- tol - 0.2
  }
}
```


### Fit for each region
```{r fit_region}
devtools::load_all()
pop <- readRDS("data/pop_by_province_20230213.rds")
dat <- readRDS("data/covid_by_province_20230213.rds")

replace_NA_with_previous <- function(x){
  for(j in 2:length(x)){   
    x[j] <- ifelse(is.na(x[j]), x[j-1], x[j]) 
  }
  return (x)
}

library(EasyABC)
prior <- list(c("unif",5,150), c("unif",1,20), 
              c("unif",-5,10), c("unif",0.1,2))

nsim <- 50
alpha <- 0.8
tol <- 8
nrep <- 10

timelim <- 10*60 # 10 minutes
# PARAMETERS
model <- sepiar_erlang_stoch
measure_var <- "CI"
erlang <- TRUE  
obslength <- 70

for(i in 1:nrow(pop)){
  d <- dat[dat$province == pop$Province_Korean[i],]
  d$day <- 0:(nrow(d)-1)
  # is this a reasonable assumption
  case_before <- d$`치료중 환자수`[1] + d$`당일 완쾌자수`[1] - d$`당일 발생자수`[1] 
  sum_stat_obs <- c(case_before, d$case[1:obslength])
  sum_stat_obs <- replace_NA_with_previous(sum_stat_obs)
  
  # set the global variables ------------------
  # initial population size by region
  pop_prov <- get_population_size(region = pop$province_clean[i])
  PARAMETERS <- params_init(I0=3, pop=pop_prov, erlang=erlang)
  PARAMETERS$model <- model
  PARAMETERS$measure_var <- measure_var
  PARAMETERS$obslength <- obslength
  # -----------------------------------------------
  tol <- 10
  
  for (s in 1:9) {
    cat("seed =", s, "\n")
    set.seed(s)
    res <- run_with_timelimit(timelim, ABC_sequential(method="Delmoral",
                            model=get_sum_stat,
                            prior=prior, nb_simul=nsim,                            summary_stat_target=sum_stat_obs, 
                            alpha=alpha,
                            tolerance_target=tol, verbose=F, M=nrep))
      
    tstamp <- timestamp(hour=T, minute=T, second=T)
    saveRDS(res, 
            sprintf("outputs/abc_erlang_alpha_%s_tol_%s_seed_%s_%s_%s.rds", alpha, tol, s, pop$province_clean[i], tstamp))
    
    if (is.null(res)) break;
    
    tol <- tol - 1
  }
}

```



### Parameters

```{r}
fls_all <- list.files("outputs/", pattern="^abc_region_overall_erlang_FALSE_alpha_0.9_tol_.*_20230224.rds$", full.names = T)

library(stringr)
# str_extract(fls[1], ".*tol_[0-9+].*_seed.*")
# number <- str_extract(fls[1], "(?<=tol\\_)\\d+\\.\\d+")
extract_tol <- function(x){
  str_extract(x, "(?<=tol\\_)\\d+\\.\\d+")
}
tols <- unlist(lapply(fls_all, function(x) extract_tol(x)))
tols <- as.double(tols)
# tols <- tols[order(tols)]
cutoff <- quantile(tols, probs=0.90)

fls <- fls_all[which(tols < cutoff)]

reslist <- vector("list", length=length(fls))
for(i in 1:length(reslist)) {
  reslist[[i]] <- readRDS(fls[i])$param
}

pars <- do.call("rbind", reslist)
pars <- pars[!duplicated(pars),]
# pars <- pars[sample(1:nrow(pars), 200),]

parm <- params_init()
sum_stat_obs <- c(350000, dnorth$symptomatic[1:parm$obslength])
# ddata <- sqrt(sum(sum_stat_obs^2))
# # stats <- matrix(NA, nrow=nrow(pars), ncol=length(sum_stat_obs))
# stats <- matrix(NA, nrow=nrow(pars), ncol=length(sum_stat_obs))
# rmse <- matrix(NA, nrow=nrow(pars), ncol=1)
# for(i in 1:nrow(pars)){
#   stats[i,] <- get_sum_stat_sepiar2(pars[i,])
#   rmse[i, ] <- sqrt(sum((stats[i,] - sum_stat_obs)^2)) / ddata
# }
```

### Plot: parameter estimates
```{r}
library(ggplot2)
# res <- readRDS("outputs/abc_4p_2023020300_seed_1.rds")
# res <- readRDS("outputs/abc_4p_20_tol_20230206T073915_seed_2.rds")
# pars <- res$param[!duplicated(res$param),]

# reslist <- vector("list", length=9)
# i <- 1
# for(s in 12:20) {
#   reslist[[i]] <- readRDS(sprintf("outputs/abc_4p_2023020500_seed_%s.rds", s))$param
#   i <- i + 1
# }
# pars <- do.call("rbind", reslist)
# pars <- pars[!duplicated(pars),]
# pars <- pars[sample(1:nrow(pars), 200),]

df <- as.data.frame(pars)
names(df) <- c("t1", "R01","t2","R02")
df2 <- df
df2$t1 <- dat$date[1] - df$t1
df2$t2 <- dat$date[1] + df$t2
  
library(GGally)
ggpairs(df2,
        upper = list(continuous = "density"),
        lower = list(combo = "facetdensity"),
        columnLabels = c("italic(t)[1]", "italic(R)[1]", "italic(t)[2]", "italic(R)[2]"),
        labeller = "label_parsed") +
  theme_bw()


ggpairs(df2,
        upper = list(continuous = "density"),
        columnLabels = c("italic(t)[1]", "italic(R)[1]", "italic(t)[2]", "italic(R)[2]"),
        labeller = "label_parsed") +
  theme_bw()

ggpairs(df2,
        columnLabels = c("italic(t)[1]", "italic(R)[1]", "italic(t)[2]", "italic(R)[2]"),
        labeller = "label_parsed") +
  theme_bw()


upperfun <- function(data,mapping){
  ggplot(data = data, mapping = mapping)+
    geom_density2d()
}   

lowerfun <- function(data,mapping){
  ggplot(data = data, mapping = mapping)+
    geom_point()
}  

p <- ggpairs(df2,upper = list(continuous = wrap(upperfun)),
        lower = list(continuous = wrap(lowerfun)), 
        columnLabels = c("italic(t)[1]", "italic(R)[1]", "italic(t)[2]", "italic(R)[2]"),
        labeller = "label_parsed") +
  theme_bw()
g
# ggsave(sprintf("plots/abc_params_%s.png", tstamp()), p, width=3.4*2, height=3.4*2)

```

### Parameter summary
```{r}
apply(pars, 2, quantile, probs=c(0.5, 0.025, 0.975) )
# introduction 
x <- quantile(df$t1, probs=c(0.025, 0.5, 0.975))
dat$date[1] - round(x)
# intervention 
x <- quantile(df$t2, probs=c(0.025, 0.5, 0.975))
dat$date[1] + round(x)
# Ratio of R0
intervention_impact <- 1 - df2[,"R02"] / df2[,"R01"]
summary(intervention_impact)
quantile(intervention_impact, probs=c(0.025, 0.5, 0.975))

# create a summary table

x <- data.frame()

```

### Run the model using the estimated parameters
```{r}
devtools::load_all()

dat <- readRDS("data/covid_overall_20230122.rds")
pop <- readRDS("data/pop_by_province_20230213.rds")

# res <- readRDS("outputs/abc_alpha_0.9_tol_3.2_seed_13_20230216T142709.rds")
# res <- readRDS("outputs/abc_region_overall_erlang_FALSE_alpha_0.9_tol_1.5_seed_2_20230223.rds")
# pars <- res$param[!duplicated(res$param),]
# apply(pars, 2, summary)

PARAMETERS <- params_init(pop=sum(pop$Total))
var <- c("CE","CI")
PARAMETERS$measure_var <- var
## run_model changes PARAMETERS$measure_var
res <- run_model(pars=pars, var=var)
ci <- res$CI
ce <- res$CE
date_start <- dat$date[1] - max(pars[,1])
ci$date <- seq(date_start, length.out=nrow(ci), by="day")
## number of case before May 13
ci_before <- ci[ci$date < dat$date[1],]
X <- rep(NA, ncol(ci_before)-1)
for(i in 1:(ncol(ci_before)-1)) {
  X[i] <- sum(ci_before[,i], na.rm=T)  
}
quantile(X, probs=c(0.025, 0.5, 0.975))

ce_before <- ce[ci$date < dat$date[1],]
X <- rep(NA, ncol(ce_before)-1)
for(i in 1:(ncol(ce_before)-1)) {
  X[i] <- sum(ce_before[,i], na.rm=T)  
}
quantile(X, probs=c(0.025, 0.5, 0.975))

quantile(apply(ce, 2, sum, na.rm=T), probs=c(0.5, 0.025, 0.975))
# quantile(apply(df, 2, sum, na.rm=T), probs=c(0.5, 0.025, 0.975))
# summary table
# 1.0% (95% CI: 1.0-3.0)
cidf <- as.data.frame(ci[,1:(ncol(ci)-1)])
# cfr_sample <- runif(ncol(cidf), min=0.1, max=10)
cfr_sample <- 1
# case fatality ratio (CFR) was assumed to be 1% based on the Johns Hopkins COVID-19 Dash board: globally 6,877,999 deaths out of 676,125,671 cases as of 7 March 2023 https://gisanddata.maps.arcgis.com/apps/dashboards/bda7594740fd40299423467b48e9ecf6

cases <- apply(cidf, 2, sum, na.rm=T)
deaths <- 0.01 * cfr_sample * cases
quantile(deaths, probs=c(0.5, 0.025, 0.975))

format_mean_95CI <- function(mean_lb_ub, digits) {
  pred <- format(round(mean_lb_ub[[1]], digits=digits), big.mark=",", trim=TRUE)
  lb <- format(round(mean_lb_ub[[2]], digits=digits), big.mark=",", trim=TRUE)
  ub <- format(round(mean_lb_ub[[3]], digits=digits), big.mark=",", trim=TRUE)

  paste0(pred, " (", lb , " - ", ub, ")")
}

sim <- summarize_model_output(model_output = res)
head(sim)
```


### Run the Erlang model using the estimated parameters
```{r}
devtools::load_all()

dat <- readRDS("data/covid_overall_20230122.rds")
pop <- readRDS("data/pop_by_province_20230213.rds")

res <- readRDS("outputs/abc_erlang_alpha_0.9_tol_9_seed_1_20230216T091250.rds")
pars <- res$param[!duplicated(res$param),]
apply(pars, 2, summary)

PARAMETERS <- params_init(pop=sum(pop$Total), erlang=TRUE)
var <- c("CE","CI")
PARAMETERS$measure_var <- var
## run_model changes PARAMETERS$measure_var
res <- run_model(pars=pars, var=var)
sim <- summarize_model_output(model_output = res)
```

### Run the Erlang model for each province
```{r}
devtools::load_all()
datall <- readRDS("data/covid_by_province_20230213.rds")
pop <- readRDS("data/pop_by_province_20230213.rds")
(pop$province_clean)

i <- 1
res <- readRDS(paste0("outputs/abc_region_", pop$province_clean[i], "_erlang_FALSE_alpha_0.9_tol_0.5_seed_1_20230217.rds"))

# res <- readRDS("outputs/abc_4p_erlang_alpha_0.8_tol_9_seed_2_ryanggang_20230214T072651.rds")
# res <- readRDS("outputs/abc_4p_erlang_alpha_0.8_tol_2_seed_9_north_hamgyong_20230214T073738.rds")
# res <- readRDS("outputs/abc_4p_erlang_alpha_0.8_tol_5_seed_6_south_hamgyong_20230214T073823.rds")
# res <- readRDS("outputs/abc_4p_erlang_alpha_0.8_tol_5_seed_6_kangwon_20230214T075746.rds")
# res <- readRDS("outputs/abc_4p_erlang_alpha_0.8_tol_7_seed_4_jagang_20230214T080821.rds")
# res <- readRDS("outputs/abc_4p_erlang_alpha_0.8_tol_10_seed_1_north_pyongan_20230214T081943.rds")
# res <- readRDS("outputs/abc_4p_erlang_alpha_0.8_tol_7_seed_4_south_pyongan_20230214T083024.rds")

pars <- res$param[!duplicated(res$param),]
apply(pars, 2, summary)

replace_NA_with_previous <- function(x){
  for(j in 2:length(x)){   
    x[j] <- ifelse(is.na(x[j]), x[j-1], x[j]) 
  }
  return (x)
}

obslength <- 70
var <- c("CE", "CI")

PARAMETERS <- params_init(I0=3, pop=pop_prov, region = pop$province_clean[i])
PARAMETERS$obslength <- obslength
PARAMETERS$measure_var <- var

dat <- datall[datall$province == pop$Province_Korean[1],]
# is this a reasonable assumption
case_before <- dat$`치료중 환자수`[1] + dat$`당일 완쾌자수`[1] - dat$`당일 발생자수`[1] 
sum_stat_obs <- c(case_before, dat$case[1:obslength])
sum_stat_obs <- replace_NA_with_previous(sum_stat_obs)
  
## run_model changes PARAMETERS$measure_var
res <- run_model(pars=pars, var=var)
sim <- summarize_model_output(model_output = res)
```


#### Plot: Model vs. data 
```{r}
library(ggplot2)
p <- plot_model_data(model=sim, data=dat, var="symp")
p
# ggsave(sprintf("plots/abc_fit%s.png", timestamp()), p, width=3.4*2, height=2.7*2)
p <- plot_model_data(model=sim, data=dat, var="inf")
p
# ggsave(sprintf("plots/abc_fit_inf_symp_%s.png", timestamp()), p, width=3.4*2, height=2.7*2)
```



### Parallel using foreach


```{r}
apply(res$param, 2, summary)

tol <- 1.1
nsim <- 200
alpha <- 0.9
m <- 5 # the number of simulation for one set of parameters (stoch model)
prior <- list(c("unif",10,300), c("unif",1,30), c("unif",0,30), c("unif",0.1,10))

library(foreach)
library(doParallel)
tic <- Sys.time()

cl <- makeCluster(8)
registerDoParallel(cl)

resp <- foreach(i=1:8,
                .packages=c("EasyABC", "COVID19NorthKorea")) %dopar% {
  set.seed(i)
  EasyABC::ABC_sequential(method="Delmoral",
                          model=COVID19NorthKorea::get_sum_stat_sepiar2,
                          prior=prior, nb_simul=nsim,
                          summary_stat_target=sum_stat_obs, alpha=alpha,
                          tolerance_target=tol, verbose=F, M=m)
}
stopImplicitCluster()

Sys.time() - tic
tstamp <- format(Sys.Date(), "%Y%m%dT%H%M")
saveRDS(resp, sprintf("outputs/abc_4p_pl_%s.rds", tstamp))
```



#### Parameter combine

```{r}
reslist <- vector("list", length=9)
i <- 1
for(s in 12:20) {
  reslist[[i]] <- readRDS(sprintf("outputs/abc_4p_2023020500_seed_%s.rds", s))$param
  i <- i + 1
}
pars <- do.call("rbind", reslist)
pars <- pars[!duplicated(pars),]
pars <- pars[sample(1:nrow(pars), 200),]

parm <- params_init()
sum_stat_obs <- c(350000, dnorth$symptomatic[1:parm$obslength])
ddata <- sqrt(sum(sum_stat_obs^2))
# stats <- matrix(NA, nrow=nrow(pars), ncol=length(sum_stat_obs))
stats <- matrix(NA, nrow=nrow(pars), ncol=length(sum_stat_obs))
rmse <- matrix(NA, nrow=nrow(pars), ncol=1)
for(i in 1:nrow(pars)){
  stats[i,] <- get_sum_stat_sepiar2(pars[i,])
  rmse[i, ] <- sqrt(sum((stats[i,] - sum_stat_obs)^2)) / ddata
}
```



```{r}

# res <- readRDS("outputs/abc_4p_19_tol_20230206T091609_seed_2.rds")
# pars <- res$param
# pars <- pars[!duplicated(pars),]
# hist(pars[,4])

library(ggplot2)
df <- as.data.frame(pars)
names(df) <- c("t1", "R01","t2","R02")

library("bayesplot")
color_scheme_set("red")
mcmc_pairs(df, pars = c("t1", "R01","t2","R02"),
           off_diag_args = list(size = 1.5))

plt <- mcmc_pairs(df, pars = names(df),
            labels = c(expression(italic(t)[1]),
                       expression(italic(R)[paste(0, ",", 1)]),
                       expression(italic(t)[2]),
                       expression(italic(R)[paste(0, ",", 2)])),  
            off_diag_args = list(size = 2, alpha = 1/3))
plt

ggsave(sprintf("plots/abc_params_%s.png", tstamp()), plt, width=3.4*2, height=3.4*2)

```



### Beaumont method 
Euler, Erlang, 4 parameters,
Two additional model parameters were introduced.
Rt1, Rt2, d1, d2

```{r}
# devtools::install()
# library(COVID19NorthKorea)
devtools::load_all()
library(EasyABC)
```

```{r}
#      
dnorth <- readRDS("outputs/NorthKorea_dat_20230122.rds")
dnorth$day <- 0:(nrow(dnorth)-1)
library(EasyABC)
prior <- list(c("unif", 5, 60), c("unif",1, 20), c("unif",-5,10), 
              c("unif", 0.1, 1))
parm <- params_init(erlang=TRUE)
sum_stat_obs = c(350000, dnorth$symptomatic[1:parm$obslength])
nsim <- 50
tolseq <- 15:10
nrep <- 1 # no repeat is necessary for the ODE model
testpars <- c(40, 6, 0, 0.6) 
get_sum_stat_sepiar_erlang_euler(pars=testpars)
# for(alpha in c(0.8,0.9,0.99)){
for (s in 1:10) {
  message("seed = ", s)
  set.seed(s)
  res <- ABC_sequential(method="Beaumont",
                        model=get_sum_stat_sepiar_erlang_euler,
                        prior=prior, nb_simul=nsim,
                        summary_stat_target=sum_stat_obs, 
                        tolerance_tab=tolseq)
  
  tstamp <- format(Sys.time(), "%Y%m%dT%H%M%S")
  saveRDS(res, sprintf("outputs/abc_4p_erlang_euler_beaumont_tolseqend_%s_seed_%s_%s.rds", tolseq[length(tolseq)], s, tstamp))
  tolseq <- c(tolseq, tolseq[length(tolseq)] - 0.7)
}
# }
```

### Epidemic curve by region
```{r}
dlist <- rio::import_list("data/(2022-0811)_코로나19_조선중앙TV_보도_현황표_시도별_일일유열자.xlsx")
nm <- names(dlist)[2:length(dlist)]
caselist <- vector("list", length(nm))
for (i in 1:length(nm)) {
  # df <- data.frame(case = dlist[[i+1]]$`당일 발생자수`)
  df <- dlist[[i+1]]
  # add a few columns to easier management and plotting
  df$case <- dlist[[i+1]]$`당일 발생자수`
  df$date <- extract_dates(dlist[[i+1]]$기준시)
  df$province <- nm[i]
  caselist[[i]] <- df
}

df <- do.call("rbind", caselist)
tstamp <- format(Sys.time(), "%Y%m%dT%H%M%S")
saveRDS(df, paste0("outputs/covid_epideimc_by_province_", tstamp,".rds"))

library(ggplot2)
p<-ggplot(df, aes(date, case))+
  geom_col(fill="brown", alpha=0.5)+
  theme_bw() +
  labs(x="", y="Symptomatic case") +
  facet_wrap(~province)
p

# tstamp <- format(Sys.time(), "%Y%m%dT%H%M%S")
# ggsave(sprintf("plots/epidemic_curve_%s.png", tstamp), p, width=3.4*3, height=2.7*3)
```

### ABC SMC parallel using foreach 
```{r}
# devtools::load_all()
# devtools::install()
library(COVID19NorthKorea)
library(foreach)
library(doParallel)

dnorth <- readRDS("outputs/NorthKorea_dat_20230122.rds")
dnorth$day <- 0:(nrow(dnorth)-1)
library(EasyABC)
prior = list(c("unif",10,200), c("unif",1,30))
sum_stat_obs = c(350000, dnorth$symptomatic[1:4])
nsim <- 100
alpha <- 0.95
# with alpha=0.8, 13 hours of run did not produce the fit, so alpha was increased to 0.95
tol <- 0.09


tic <- Sys.time()

cl <- makeCluster(8)
registerDoParallel(cl)

resp <- foreach(i=1:8,
                .packages=c("EasyABC", "COVID19NorthKorea")) %dopar% {
  set.seed(i)
  # seed has a big impact on the performance of the algorithm.
  # set.seed(1..9) works fine.   
  # set.seed(10) doesn't seem to be generating an converging simulation ..          
  EasyABC::ABC_sequential(method="Delmoral",
                          model=COVID19NorthKorea::get_sum_stat,
                          prior=prior, nb_simul=nsim,
                          summary_stat_target=sum_stat_obs, 
                          alpha=alpha,
                          tolerance_target=tol, verbose=F, M=5)
}
stopImplicitCluster()

Sys.time() - tic
```


## Back of an envelope calculation 
```{r}
I <- 4000000 # number of symptomatic cases
D <- 74 # number of deaths
p <- 0.01 # case fatality ratio for omicron
# Assuming that the number of cases are Omicron cases and the death is a Bernoulli trial with a given probability p (i.e., Omicron case fatality ratio), the number of deaths are distributed as Binom(I,p)
# choose(4000,40)*p^40*(1-p)^(4000-40)
# dbinom(40,4000,p)
df <- data.frame(X=0:I, prob=NA)
df$prob <- dbinom(df$X, I, p)
df$lik <- dbinom(D, 0:I, p)
sum(df$prob)
sum(df$lik)
summary(df$lik)
posprob = which(df$prob > 1e-8)
poslik = which(df$lik > 1e-8)
plot(df$X[posprob], df$prob[posprob])
plot(df$X[poslik], df$lik[poslik])

library(ggplot2)
library(dplyr)

df[posprob,] %>%
  ggplot()+
  geom_line(aes(X, prob))+
  theme_bw()


df[poslik,] %>% 
  ggplot()+
  geom_line(aes(X,lik))+
  theme_bw()

# Assuming that the number of deaths are reliable and they are all COVID-related, in particular (Omicron-related deaths)
# Y<- dbinom(0:I, D, p)

```

### Compare exponential growth
```{r}
R0 <- 3
gamma = 0.15
beta = R0*gamma
parm=c(beta=beta, gamma=gamma)
I0=0.001
y0=c(S=0.999,I=I0,R=0)
res=SIR_step(params=parm, y0=y0, tend=100, saveat=1, dt=0.001)
tail(res)
final_epidemic_size(R0=3)

res2=exp_growth_step(params=c(r=(R0-1)*gamma), y0=c(I=I0), tend=100, saveat=1, dt=0.001)
```
### Global COVID-19 data set
```{r}
confirmed = data.table::fread("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")

deaths = data.table::fread("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")

recovered = data.table::fread("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")
```

