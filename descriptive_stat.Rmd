---
title: "Differential evolution"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

### Epidemic curve by region
```{r}
library(COVID19NorthKorea)
dlist <- rio::import_list("inst/extdata/(2022-0811)_코로나19_조선중앙TV_보도_현황표_시도별_일일유열자.xlsx")
nm <- names(dlist)[2:length(dlist)]
caselist <- vector("list", length(nm))
for (i in 1:length(nm)) {
  # df <- data.frame(case = dlist[[i+1]]$`당일 발생자수`)
  df <- dlist[[i+1]]
  # add a few columns to easier management and plotting
  df$case <- dlist[[i+1]]$`당일 발생자수`
  df$date <- extract_dates(dlist[[i+1]]$기준시)
  df$province <- nm[i]
  caselist[[i]] <- df
}

df <- do.call("rbind", caselist)

# saveRDS(df, paste0("outputs/covid_epideimc_by_province_", tstamp(),".rds"))

# library(ggplot2)
# p<-ggplot(df, aes(date, case))+
#   geom_col(fill="brown", alpha=0.5)+
#   theme_bw() +
#   labs(x="", y="Symptomatic case") +
#   facet_wrap(~province)
# p
# ggsave(sprintf("plots/epidemic_curve_%s.png", tstamp()), p, width=3.4*3, height=2.7*3)

# attack rates
library(dplyr)
df %>%
  group_by(province) %>%
  summarize(recovered = sum(`당일 완쾌자수`, na.rm=T), 
            deaths = sum(`당일 사망자 수`, na.rm=T),
            inf = recovered + deaths) -> df_prov 
                    
df_prov$Province_Korean = df_prov$province

pop = POP[,c("Total", "Province_Korean", "Province")]
df_prov = left_join(df_prov, pop, by="Province_Korean")
df_prov$attack_rate = 100 * df_prov$inf / df_prov$Total

# Alternative
# 개성 = 황해북도 https://namu.wiki/w/%EA%B0%9C%EC%84%B1%EC%8B%9C
# 나선 = 함경북도 https://namu.wiki/w/%EB%9D%BC%EC%84%A0%EC%8B%9C?from=%EB%82%98%EC%84%A0%EC%8B%9C
df_prov[df_prov$province == "황북","inf"] = df_prov[df_prov$province == "황북","inf"] +  df_prov[df_prov$province == "개성","inf"] 
df_prov[df_prov$province == "함북","inf"] = df_prov[df_prov$province == "함북","inf"] +  df_prov[df_prov$province == "나선","inf"]
df_prov$attack_rate = 100 * df_prov$inf / df_prov$Total

# shapefile ggplot2 plotting guide
# https://rstudio-pubs-static.s3.amazonaws.com/280176_81148aa4c2024d6ca6e9d21598a3e41f.html

dprk = rgdal::readOGR("inst/extdata/gadm41_PRK_shp", "gadm41_PRK_1")
dprk@data$name_kor = c("자강","함북","함남","황북","황남","개성","강원","강원","평북","평남","평양","나선","양강","평북")
dprk@data$AR = NA
nm = dprk@data$name_kor
for (n in nm){
  dprk@data[dprk@data$name_kor == n,]$AR = df_prov[df_prov$Province_Korean == n,]$attack_rate
}
dprk@data[dprk@data$name_kor  == "개성",]$AR =
  df_prov[df_prov$Province_Korean == "황북",]$attack_rate
dprk@data[dprk@data$name_kor  == "나선",]$AR =
  df_prov[df_prov$Province_Korean == "함북",]$attack_rate

dprk_df <- broom::tidy(dprk, region = "AR")
head(dprk_df)
dprk_df$id <- as.double(dprk_df$id) # attack rate

library(RColorBrewer)
map <- ggplot(data=dprk_df) +
  geom_polygon(aes(x = long, y = lat, group = group, fill=id),
            color = 'black', linewidth = 0.5) +
  scale_fill_gradientn(colors = brewer.pal(9, "YlOrBr"),
                       limits = c(0, max(dprk_df$id)),
                       breaks = seq(0, max(dprk_df$id), 5),
                       "Attack rate (%)")+
  coord_equal() +
  theme_map(legend_position = c(0.9, 0.3)) +
  theme(legend.title = element_text(size=12),
        legend.text = element_text(size=12))

# ggsave(paste0("plots/ar_", tstamp(), ".png"),
#          map, width=7.4, height=7.4, units="in")



# df_prov$province_shape = c("Kangwŏn-do", "Kaesŏng", "Rasŏn", "P'yŏngan-namdo", "Ryanggang", "Chagang-do", "P'yŏngan-namdo", "P'yŏngan-bukto","P'yŏngyang", "Hamgyŏng-namdo", "Hamgyŏng-bukto", "Hwanghae-namdo","Hwanghae-bukto", "P'yŏngan-bukto")


# library(raster)
# # dprk = shapefile("inst/extdata/gadm41_PRK_shp/gadm41_PRK_1.shp")
# 
# shp = rgdal::readOGR("inst/extdata/gadm41_PRK_shp", "gadm41_PRK_1")
# map <- ggplot() + 
#   geom_polygon(data = dprk,
#                aes(x = long, y = lat, group = group),
#                colour = "black", fill = NA) +
#   theme_map()
# 
# shp_df <- broom::tidy(shp, region = "NAME_1")
# ## Regions defined for each Polygons
# cnames <- aggregate(cbind(long, lat) ~ id, data=shp_df, FUN=mean)
# map + 
#   geom_text(data = cnames, aes(x = long, y = lat, label = id), size = 4) +
#   theme_map()
# 



# library(rgdal)     # R wrapper around GDAL/OGR
#   # for general plotting
# library(ggmap)    # for fortifying shapefiles

# Now the shapefile can be plotted as either a geom_path or a geom_polygon.
# Paths handle clipping better. Polygons can be filled.
# You need the aesthetics long, lat, and group.
# map <- 
#   ggplot() +
#   geom_path(data = shape_df, 
#             aes(x = long, y = lat, group = group),
#             color = 'gray', fill="white", size = .2)
# 
# print(map) 
# 
# library(RColorBrewer)
# pal <- brewer.pal(9, "YlOrBr")
# my_palette <- colorRampPalette(pal)
# ggplot(data=shape_df) +
#   geom_path(aes(x = long, y = lat, group = group),
#             color = 'black', linewidth = 0.5) +
#   scale_fill_gradientn(limits = c(0, 50),
#                        breaks = seq(0, 50, 10),
#                        colors = my_palette,
#                        "Attack rate") +
    # geom_polygon(data = shape2, aes(long, lat, group = group),
    #              fill = NA, inherit.aes = FALSE) +
    # geom_path(data = shape2, aes(long, lat, group = group),
    #           color = "black", linewidth = 0.2, inherit.aes = FALSE) +
# 
#     geom_polygon(data = shape, aes(long, lat, group = group),
#                  fill = NA, inherit.aes = FALSE) +
#     geom_path(data = shape, aes(long, lat, group = group),
#               color = "black", linewidth = 0.9, inherit.aes = FALSE) +
    # coord_equal() +
    # theme_map() +
    # theme(legend.title = element_text(size=12),
    #       legend.text = element_text(size=12))


# package sf way
# library(sf)
# # dprk <- sf::read_sf("inst/extdata/gadm41_PRK_shp/gadm41_PRK_1.shp")
# dprk <- st_as_sf(dprk)
# plot(dprk)
# plot(dprk["AR"], main="Attack rate")

# ggplot(data = dprk) +
#   geom_sf(aes(fill=AR))
  
  

# First read in the shapefile, using the path to the shapefile and the shapefile name minus the
# extension as arguments
# shapefile <- readOGR("inst/extdata/gadm41_PRK_shp", "gadm41_PRK_1.shp")
# 
# # Next the shapefile has to be converted to a dataframe for use in ggplot2
# shapefile_df <- fortify(shapefile)
# 
# # Now the shapefile can be plotted as either a geom_path or a geom_polygon.
# # Paths handle clipping better. Polygons can be filled.
# # You need the aesthetics long, lat, and group.
# map <- ggplot() +
# geom_path(data = shapefile_df, 
#           aes(x = long, y = lat, group = group),
#           color = 'gray', fill = 'white', size = .2)
# 
# print(map) 

# df = as.data.frame(dprk)
# df$name_kor = c("자강","함북","함남","황북","황남","개성","강원","강원","평북","평남","평양","나선","양강","평북")
# nm = df$name_kor
# for (n in nm){
#   df[df$name_kor == n,]$AR = df_prov[df_prov$Province_Korean == n,]$attack_rate
# }
#  df[df$name_kor == "개성",]$AR = df_prov[df_prov$Province_Korean == "황북",]$attack_rate
#  df[df$name_kor == "나선",]$AR = df_prov[df_prov$Province_Korean == "함북",]$attack_rate
# 

 
# get_peak <- function(df) {
#   
# }

```

### Time series imputation

```{r}
library(COVID19NorthKorea)
dlist <- rio::import_list("inst/extdata/(2022-0811)_코로나19_조선중앙TV_보도_현황표_시도별_일일유열자.xlsx")
nm <- names(dlist)[2:length(dlist)]
caselist <- vector("list", length(nm))
for (i in 1:length(nm)) {
  # df <- data.frame(case = dlist[[i+1]]$`당일 발생자수`)
  df <- dlist[[i+1]]
  # add a few columns to easier management and plotting
  df$case <- dlist[[i+1]]$`당일 발생자수`
  df$date <- extract_dates(dlist[[i+1]]$기준시)
  df$province <- nm[i]
  caselist[[i]] <- df
}

df <- do.call("rbind", caselist)
names(df)

df1 = df[df$province == "평양",]
ts = df1$`당일 발생자수`
sum(ts, na.rm=T)
library(imputeTS)
ts_im = na_interpolation(x=ts)
sum(ts_im)
region = unique(df$province)
m <- matrix(NA, nrow=73, ncol=length(region)) 
for (i in 1:length(region)) {
  ts = df[df$province == region[i],]$`당일 발생자수`
  # m[,i] <- na_interpolation(ts)
  m[,i] <- na_interpolation(ts, option = "spline")
}
sum(colSums(m))
sum(rowSums(m))
```


### Population density by region 

To explore the association between the population density and the attack rate

Use population per pixel [ppp] (WorldPop https://hub.worldpop.org/geodata/summary?id=27086) and assume that each pixel is around 100m by 100m (at a resolution of 3 arc, i.e., approximately 100m at the equator).
To calculate the population density, sum ppp across the grids that fall on the
region of interest and divide it with the number of grids. 

Two rasters (ppp and ir_*) have the same resolutions and were not aligned perfectly and therefore, resample is done as ppp for 0-1 yo as the reference
```{r}
library(raster)
ppp = raster("inst/extdata/prk_ppp_2020_UNadj.tif")
dprk = rgdal::readOGR("inst/extdata/gadm41_PRK_shp", "gadm41_PRK_1")
dprk@data$name_kor = c("자강","함북","함남","황북","황남","개성","강원","강원",
                       "평북","평남","평양","나선","양강","평북")

density_by_region <- function(polygon, raster){
  nms <- unique(polygon@data$name_kor)
  out <- data.frame(Province_Korean = nms, num_cells=NA, pop_density=NA)
  for (i in 1:length(nms)) {
    poly = polygon[polygon@data$name_kor == out$Province_Korean[i],]
    cells <- raster::extract(raster, poly, df = TRUE, cellnumbers = TRUE)
    out$num_cells[i] <- nrow(cells)
    out$pop[i] <- sum(cells$prk_ppp_2020_UNadj, na.rm=T)
    out$pop_density[i] <- out$pop[i] / out$num_cells[i]
  }
  return(out)
}
den <- density_by_region(dprk, ppp)
names(den) <- c("Province_Korean", names(den)[2:4])
df <- dplyr::left_join(df_prov, den, by="Province_Korean")

# data.table::fwrite(df, "outputs/pop_density_AR.csv")
df <- data.table::fread("outputs/pop_density_AR.csv")

plot(df$pop_density, df$attack_rate)
library(Hmisc)
Hmisc:::rcorr(x=as.matrix(df[,c("pop_density", "attack_rate")]), type="pearson")
```

### Case fatality ratio

```{r}
library(COVID19NorthKorea)
dlist <- rio::import_list("inst/extdata/(2022-0811)_코로나19_조선중앙TV_보도_현황표_시도별_일일유열자.xlsx")
nm <- names(dlist)[2:length(dlist)]
caselist <- vector("list", length(nm))
for (i in 1:length(nm)) {
  # df <- data.frame(case = dlist[[i+1]]$`당일 발생자수`)
  df <- dlist[[i+1]]
  # add a few columns to easier management and plotting
  df$case <- dlist[[i+1]]$`당일 발생자수`
  df$date <- extract_dates(dlist[[i+1]]$기준시)
  df$province <- nm[i]
  caselist[[i]] <- df
}

df <- do.call("rbind", caselist)

# saveRDS(df, paste0("outputs/covid_epideimc_by_province_", tstamp(),".rds"))

# ggsave(sprintf("plots/epidemic_curve_%s.png", tstamp()), p, width=3.4*3, height=2.7*3)

# attack rates
library(dplyr)
df %>%
  group_by(province) %>%
  summarize(recovered = sum(`당일 완쾌자수`, na.rm=T), 
            deaths = sum(`당일 사망자 수`, na.rm=T),
            inf = recovered + deaths) -> df_prov 

x = sum(df_prov$deaths) 
n = x +  sum(df_prov$inf)
p = x / n

se = sqrt(p*(1-p)/n)
ub = p + qnorm(0.975)*se
lb = p - qnorm(0.975)*se
formatC(c(p,lb,ub), format = "e", digits = 6)

prop.test(x=x, n=n, conf.level=.95, correct=FALSE)

library(Hmisc)
binconf(x=x, n=n, alpha=.05)
binconf(x=x, n=n, alpha=.05, method="asymptotic")

# likelihood of observation across varied varied 
p_varied = seq(8e-10, 1e-2, length.out=100)
LL = dbinom(x=x, size=n, prob=p_varied, log=TRUE)
plot(p_varied, LL, type="l")
# plot(p_varied[1:10], LL[1:10], type="l")
abline(v=0.0304, col=2)
abline(v=c(0.0187, 0.0748), col=2, lty=2)
# 1.  Wang C, Liu B, Zhang S, Huang N, Zhao T, Lu Q-B, et al. Differences in incidence and fatality of COVID-19 by SARS-CoV-2 Omicron variant versus Delta variant in relation to vaccine coverage: A world-wide review. Journal of Medical Virology. 2023;95: e28118. doi:10.1002/jmv.28118
# 3.04 (IQR: 1.87–7.48)
cfr_omicron = 0.0304
x_varied = 1:300000
LL = dbinom(x=x_varied, size=n, prob=cfr_omicron, log=TRUE)
plot(x_varied, LL, type="l")
abline(v=x, col=2)
```


Examines the likelihood of case fatality ratio given the number of cases and
deaths
```{r}
library(COVID19NorthKorea)
d = readRDS("inst/extdata/covid_overall_20230122.rds")
x = tail(d$cumul_deaths, 1) # deaths
n = tail(d$cumul_recovered,1) + tail(d$cumul_deaths, 1) # total cases

p = x / n

se = sqrt(p*(1-p)/n)
ub = p + qnorm(0.975)*se
lb = p - qnorm(0.975)*se
formatC(c(p,lb,ub), format = "e", digits = 6)

prop.test(x=x, n=n, conf.level=.95, correct=FALSE)

library(Hmisc)
binconf(x=x, n=n, alpha=.05)
binconf(x=x, n=n, alpha=.05, method="asymptotic")
pr = seq(from=1e-6,to=1e-2,length.out=10000)
loglik = function(pr) dbinom(x, n, prob=pr, log=TRUE)
plot(pr, loglik(pr), type="l")
points(p, loglik(p), col=2, cex=2)
points(0.003, loglik(0.003), col=2, cex=2)
# likelihood of observation across varied varied 
p_varied = seq(8e-10, 1e-2, length.out=100)
LL = dbinom(x=x, size=n, prob=p_varied, log=TRUE)
plot(p_varied, LL, type="l")
# plot(p_varied[1:10], LL[1:10], type="l")
abline(v=0.0304, col=2)
abline(v=c(0.0187, 0.0748), col=2, lty=2)
# 1.  Wang C, Liu B, Zhang S, Huang N, Zhao T, Lu Q-B, et al. Differences in incidence and fatality of COVID-19 by SARS-CoV-2 Omicron variant versus Delta variant in relation to vaccine coverage: A world-wide review. Journal of Medical Virology. 2023;95: e28118. doi:10.1002/jmv.28118
# 3.04 (IQR: 1.87–7.48)

cfr_omicron = 0.0304
x_varied = 0:100
df1 = data.frame(x=x_varied, prob=dbinom(x=x_varied, size=n, prob=cfr_omicron))
# plot(x_varied, pr, type="h")
# abline(v=x, col=2)

x_varied2 = seq(140000, 150000, by=100)
df2 = data.frame(x=x_varied2, prob=dbinom(x=x_varied2, size=n, prob=cfr_omicron))

library(ggplot2)
p1 <- ggplot(df1) +
  geom_col(aes(x=x, y=prob), fill="steelblue") +
  geom_point(aes(74, dbinom(74, size=4772813, prob=cfr_omicron)),
             shape=8, size=1, stroke=1, col="blue")+
  scale_y_continuous(limits=c(0,1.2e-3))+
  labs(x="", y="Probability")+
  theme_minimal()+
  theme(axis.title.x = element_blank(),
        plot.margin = unit(c(5.5,-2.5,5.5,5.5),"pt"))

p2 <- ggplot(df2)+
  geom_col(aes(x=x, y=prob), fill="steelblue") +
  scale_y_continuous(limits=c(0,1.2e-3))+
  labs(x="", y="")+
  theme_minimal()+
  theme(axis.title.x = element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        plot.margin = unit(c(5.5,5.5,5.5,-2.5),"pt"))

library(ggplot2)
library(gridExtra)
p <- grid.arrange(
  grobs=list(p1, p2),
  nrow=1, 
  widths = c(1,2),
  bottom = "Expected death")

ggsave(sprintf("plots/death_dist_%s.png", tstamp()), p, width=3.4*2, height=2.7*2)


# 3.04 (IQR: 1.87–7.48)

# Expected cases distribution
cfr_omicron = 0.0304
x = 74
nrange = seq(1000, 5000, by=100)
df1 = data.frame(n=nrange,
                 lik=dbinom(x=x, size=nrange, prob=cfr_omicron))

nrange2 = seq(1e6, 5e6, by=1000)
df2 = data.frame(n=nrange2,
                 lik=dbinom(x=x, size=nrange2, prob=cfr_omicron))


library(ggplot2)
p1 <- ggplot(df1) +
  geom_col(aes(x=n, y=lik), fill="brown") +
  scale_y_continuous(limits = c(0,0.05))+
  labs(x="", y="Likelihood")+
  theme_minimal()+
  theme(axis.title.x = element_blank(),
        plot.margin = unit(c(5.5,-2.5,5.5,5.5),"pt"))

p2 <- ggplot(df2)+
  geom_col(aes(x=n, y=lik), fill="brown") +
  geom_point(aes(4772813, dbinom(74, size=4772813, prob=cfr_omicron)),
             shape=8, size=1, stroke=1, col="firebrick")+
  scale_y_continuous(limits = c(0,0.05))+
  labs(x="", y="")+
  theme_minimal()+
  theme(axis.title.x = element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        plot.margin = unit(c(5.5,5.5,5.5,-2.5),"pt"))

library(gridExtra)
p <- grid.arrange(
  grobs=list(p1, p2),
  nrow=1, 
  widths = c(2, 1),
  bottom = "Expected cases")

ggsave(sprintf("plots/cases_dist_%s.png", tstamp()), p,
       width=3.4*2, height=2.7*2)
```


